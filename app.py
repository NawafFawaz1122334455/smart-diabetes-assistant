"**ÙˆØ²Ù† Ø²Ø§Ø¦Ø¯/Ø³Ù…Ù†Ø©:** Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„ØªÙ…Ø§Ø±ÙŠÙ† **Ø§Ù„ÙƒØ§Ø±Ø¯ÙŠÙˆ Ø§Ù„Ù…Ø¹ØªØ¯Ù„Ø© (Ù…Ø«Ù„ Ø§Ù„Ù…Ø´ÙŠ Ø§Ù„Ø³Ø±ÙŠØ¹ ÙˆØ§Ù„Ù‡Ø±ÙˆÙ„Ø©)** Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„ØªØ£Ø«ÙŠØ± Ù„Ù…Ø¯Ø© 150 Ø¯Ù‚ÙŠÙ‚Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹. **Ø®Ø·Ø© ØºØ°Ø§Ø¦ÙŠØ©:** Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ© ÙˆØ§Ù„Ø³ÙƒØ±ÙŠØ§Øª ÙˆØ§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª Ø§Ù„Ù…ØµÙ†Ø¹Ø©.",
        
        'rec_over_40_light': "**Ù†Ø­Ø§ÙØ©/ÙˆØ²Ù† ØµØ­ÙŠ:** Ø±ÙƒØ² Ø¹Ù„Ù‰ **Ø§Ù„Ù…Ø±ÙˆÙ†Ø© ÙˆØ§Ù„ØªØ­Ù…Ù„** Ø¨ØªÙ…Ø§Ø±ÙŠÙ† Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„ØªØ£Ø«ÙŠØ± Ù…Ø«Ù„ Ø§Ù„ÙŠÙˆØºØ§ ÙˆØ§Ù„Ù…Ø´ÙŠ ÙˆØ§Ù„Ø³Ø¨Ø§Ø­Ø©. Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù†Ø¸Ø§Ù…Ùƒ Ø§Ù„ØºØ°Ø§Ø¦ÙŠ Ø§Ù„ØºÙ†ÙŠ Ø¨Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†.",
        'rec_over_40_heavy': "**ÙˆØ²Ù† Ø²Ø§Ø¦Ø¯/Ø³Ù…Ù†Ø©:** Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ† Ø§Ù„Ù…Ø«Ù„Ù‰ Ù‡ÙŠ **Ø§Ù„Ø³Ø¨Ø§Ø­Ø© Ø£Ùˆ Ø§Ù„Ù…Ø´ÙŠ Ø£Ùˆ Ø±ÙƒÙˆØ¨ Ø§Ù„Ø¯Ø±Ø§Ø¬Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ©** Ù„ØªØ¬Ù†Ø¨ Ø¥Ø¬Ù‡Ø§Ø¯ Ø§Ù„Ù…ÙØ§ØµÙ„. **Ø®Ø·Ø© ØºØ°Ø§Ø¦ÙŠØ©:** ÙŠØ¬Ø¨ Ø£Ù† ØªØ±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø·Ø¹Ù…Ø© Ø§Ù„ØºÙ†ÙŠØ© Ø¨Ø§Ù„Ø£Ù„ÙŠØ§Ù ÙˆØ§Ù„Ù…Ø¹Ø§Ø¯Ù† Ù„ØªØ¹Ø²ÙŠØ² Ø§Ù„Ø´Ø¨Ø¹ ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø³ÙƒØ±.",
        # Ù…ÙØ§ØªÙŠØ­ Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙˆØ±
        'manage_page_images': "Ø¥Ø¯Ø§Ø±Ø© ØµÙˆØ± Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
        'home_image': "ØµÙˆØ±Ø© ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
        'exercise_image': "ØµÙˆØ±Ø© ØµÙØ­Ø© Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†",
        'water_image': "ØµÙˆØ±Ø© ØµÙØ­Ø© Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…ÙŠØ§Ù‡",
        'select_image_to_upload': "Ø§Ø®ØªØ± Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­Ø¯ÙŠØ«Ù‡Ø§",
        'upload_page_image_button': "ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©",
        'image_updated_success': "ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„ØµÙØ­Ø© Ø¨Ù†Ø¬Ø§Ø­!",
        'image_updated_failed': "ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„ØµÙØ­Ø©:",
        'no_image_uploaded': "Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù ØµÙˆØ±Ø©."
    },
    'en': {
        'app_title': "Smart Diabetes Assistant",
        'welcome': "Welcome to the Smart Diabetes Assistant",
        'app_purpose': "This app is designed to help you manage your health.",
        'explore_features': "Use the navigation menu to explore different features.",
        'login_register': "Login or Register",
        'otp_note': "Note: Login and registration are handled using Email, Password, and a One-Time Password (OTP) for verification.",
        
        # New Auth Keys
        'enter_email': "Email",
        'password_label': "Password (6 characters or more)",
        'login_button': "Login",
        'signup_button': "Sign Up",
        'forgot_password_button': "Forgot Password? (Temporary Login)",

        'enter_email_password_warning': "Please enter email and password.",
        'password_length_error': "Error: Password must be at least 6 characters.",

        'signup_success': "Registration successful! Please proceed to login (OTP will be required).",
        'signup_error': "Signup Error:",

        'verification_success': "Login successful! You are now logged in.",
        'login_invalid': "Invalid login credentials. Please check your email and password.",
        'verification_error': "Login Error:",
        
        'enter_email_for_reset': "Enter your email to send a One-Time Password (OTP)",
        'send_reset_link_button': "Send Verification Code",
        'password_reset_sent': "A password reset link has been sent to your email. **You must configure the Confirmation URL in Supabase/Auth/Email Templates.**",
        'password_reset_error': "Error resetting password:",
        
        # New OTP Keys
        'verify_otp_title': "Two-Factor Verification (OTP)",
        'otp_sent_info': "A 6-digit verification code has been sent to your email. Please check your inbox (and spam folder).",
        'enter_otp': "Enter OTP Code",
        'verify_otp_button': "Verify Code",
        'otp_invalid': "Invalid or expired OTP code.",
        'otp_error': "OTP Verification Error:",
        
        # General Keys
        'logout': "Logout",
        'logged_out': "You have been logged out.",
        'navigation': "Navigation",
        'home_page': "Home",
        'products_page': "Product Catalog",
        'admin_page': "Admin Dashboard",
        'water_page': "Daily Water Calculator",
        'exercise_page': "Exercise Recommendations",
        'admin_dashboard': "Admin Dashboard",
        'admin_password': "Enter Admin Password",
        'admin_access_denied': "Incorrect password. Access denied.",
        'add_product': "Add a New Product",
        'product_name': "Product Name",
        'calories': "Calories",
        'sugar_g': "Sugar (g)",
        'carbs_g': "Carbohydrates (g)",
        'protein_g': "Protein (g)",
        'fats_g': "Fats (g)",
        'suitability_question': "Is this product suitable for diabetics?",
        'suitable': "Suitable",
        'moderately_suitable': "Moderately Suitable",
        'not_suitable': "Not Suitable",
        'upload_image': "Upload Product Image",
        'add_product_button': "Add Product",
        'fill_all_fields': "Please fill in all required fields and upload an image.",
        'adding_product_spinner': "Adding product...",
        'product_added_success': "Product added successfully!",
        'product_added_failed': "Failed to add product:",
        'edit_delete_product': "Edit or Delete Existing Product",
        'select_product_to_edit': "Select a product to edit",
        'update_product': "Update Product",
        'delete_product': "Delete Product",
        'upload_new_image': "Upload new image (optional)",
        'updating_image_spinner': "Uploading new image...",
        'product_updated_success': "Product updated successfully!",
        'product_updated_failed': "Failed to update product:",
        'product_deleted_success': "Product deleted successfully!",
        'product_deleted_failed': "Failed to delete product:",
        'no_products_available': "No products available to edit or delete.",
        'error_loading_products': "Error loading products for edit/delete:",
        'search_product': "Search for a product...",
        'suitability_label': "Suitability",
        'no_products_found': "No products found.",
        'error_fetching_products': "Error fetching products:",
        'recommended_intake': "Your recommended daily water intake is",
        'water_calc_title': "Water Intake Calculator",
        'water_calc_desc': "Calculate your recommended daily water intake based on your weight and age.",
        'water_tips_title': "General Tips for Diabetics",
        'water_tip1': "Balanced Diet: Focus on whole foods, fruits, vegetables, and lean proteins.",
        'water_tip2': "Regular Exercise: Aim for at least 30 minutes of moderate exercise most days of the week.",
        'water_tip3': "Monitor Blood Sugar: Check your blood sugar levels regularly as advised by your doctor.",
        'water_tip4': "Stay Hydrated: Drinking enough water helps manage blood sugar levels.",
        'weight_kg': "Your Weight (in kg)",
        'age_years': "Your Age (in years)",
        'calculate': "Calculate",
        'realistic_input_warning': "Please enter a realistic weight (e.g., above 15 kg) and age (e.g., above 5 years) to get a valid recommendation.",
        'liters': "liters",
        'current_consumption': "Current Consumption",
        'daily_goal': "Daily Goal",
        'log_glass': "Drank a glass of water ($250 \text{ml}$)",
        'reset_water': "Reset Consumption",
        'goal_reached': "Congratulations! You have reached or exceeded your daily goal! ğŸ¥³",
        'exercise_title': "Exercise Recommendations",
        'exercise_desc': "Find a sport that's suitable for you based on your age and weight.",
        'get_rec': "Get Recommendation",
        'exercise_tips_title': "Tips on Exercising with Diabetes",
        'exercise_tip1': "Consult a Doctor: Always talk to your doctor before starting a new exercise program.",
        'exercise_tip2': "Check Blood Sugar: Check your blood sugar before and after exercise to see how your body responds.",
        'exercise_tip3': "Stay Hydrated: Drink plenty of water before, during, and after your workout.",
        'exercise_tip4': "Carry a Snack: Keep a quick source of glucose with you in case of a low blood sugar episode.",
        'loading_image_error': "Error loading image:",
        'image_upload_error': "Error uploading image:",
        'db_config_error': "Error: Supabase environment variables are not set. Please check your .env file.",
        'db_connect_error': "Error connecting to Supabase:",
       'rec_realistic_input': "Please enter a realistic age and weight. Please consult a doctor or dietitian for the appropriate plan.",
        'rec_under_18_updated': "**Children & Teens:** Focus on **one hour** of fun physical activity daily, such as free play, swimming, or team sports. **Diet Note:** Ensure a balanced diet to meet growth and energy needs.",
        
        'rec_18_40_underweight': "**Underweight (Needs Gain):** Focus on **strength and resistance training** to build muscle mass. **Diet Plan:** You need to increase healthy calories and protein intake (consult a dietitian).",
        'rec_18_40_healthy': "**Healthy Weight:** Continue a mix of cardio (running, swimming) and strength training 3-5 times a week to maintain your weight and overall health.",
        'rec_18_40_overweight': "**Overweight/Obesity:** Prioritize **moderate cardio (like brisk walking and jogging)** with low impact for 150 minutes per week. **Diet Plan:** Focus on reducing calories, sugars, and processed carbs.",
        
        'rec_over_40_light': "**Underweight/Healthy Weight:** Focus on **flexibility and endurance** with low-impact exercises like yoga, walking, and swimming. Maintain your high-protein diet.",
        'rec_over_40_heavy': "**Overweight/Obesity:** Optimal exercises are **swimming, walking, or stationary cycling** to avoid joint strain. **Diet Plan:** Your focus should be on fiber-rich and mineral-rich foods to boost satiety and blood sugar control.",
        # Ù…ÙØ§ØªÙŠØ­ Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙˆØ±
        'manage_page_images': "Manage Main Page Images",
        'home_image': "Home Page Image",
        'exercise_image': "Exercise Page Image",
        'water_image': "Water Calculator Page Image",
        'select_image_to_upload': "Select Image to Update",
        'upload_page_image_button': "Update Image",
        'image_updated_success': "Page image updated successfully!",
        'image_updated_failed': "Failed to update page image:",
        'no_image_uploaded': "Please upload an image file."
    }
}

def t(key):
    """Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù†Øµ Ø§Ù„Ù…ØªØ±Ø¬Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©."""
    lang = st.session_state.get('language', 'ar')
    return TRANSLATIONS[lang].get(key, key) 

# --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª (Setup and Caching Functions) ---

load_dotenv()

# Ø§Ø³ØªØ®Ø¯Ø§Ù… st.cache_resource Ù„Ø¶Ù…Ø§Ù† ØªÙ‡ÙŠØ¦Ø© Supabase Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
@st.cache_resource
def init_supabase_client() -> Client | None:
    """ØªÙ‡ÙŠØ¦Ø© Ø¹Ù…ÙŠÙ„ Supabase ÙˆØ¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ©."""
    supabase_url: str = os.environ.get("SUPABASE_URL")
    supabase_key: str = os.environ.get("SUPABASE_KEY")

    if not supabase_url or not supabase_key:
        st.error(t('db_config_error'))
        return None
    try:
        # st.cache_resource ÙŠØ¶Ù…Ù† Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„ÙƒØ§Ø¦Ù† Ù„Ø§ ÙŠÙÙ†Ø´Ø£ Ø¥Ù„Ø§ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
        return create_client(supabase_url, supabase_key)
    except Exception as e:
        st.error(f"{t('db_connect_error')} {e}")
        return None

def init_session_state():
    """ØªÙ‡ÙŠØ¦Ø© Ù…ØªØºÙŠØ±Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø³Ø© (Session State)."""
    if 'user' not in st.session_state:
        st.session_state['user'] = None
    if 'page' not in st.session_state:
        st.session_state['page'] = 'Home'
    if 'language' not in st.session_state: # Ø­Ø§Ù„Ø© Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        st.session_state['language'] = 'ar' # Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
    # Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ­Ø¯ÙŠØ¯ ÙˆØ¶Ø¹ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    if 'auth_mode' not in st.session_state:
        st.session_state['auth_mode'] = 'login' 
    # Ø­Ø§Ù„Ø© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø¤Ù‚ØªØ§Ù‹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† OTP
    if 'temp_email' not in st.session_state:
        st.session_state['temp_email'] = None 
    # Ø­Ø§Ù„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø§Ø¡
    if 'water_goal_liters' not in st.session_state:
        st.session_state['water_goal_liters'] = 0.0 # Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø¨Ø§Ù„Ù„ØªØ±
    if 'water_consumed_ml' not in st.session_state:
        st.session_state['water_consumed_ml'] = 0 # Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ© Ø¨Ø§Ù„Ù…Ù„ÙŠÙ„ØªØ±
    
    # Ø­Ø§Ù„Ø© Ù„ØªØ®Ø²ÙŠÙ† Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµÙˆØ± Ù…Ø¤Ù‚ØªØ§Ù‹
    if 'page_image_urls' not in st.session_state:
        st.session_state['page_image_urls'] = {}

# --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ ---
supabase = init_supabase_client()
init_session_state()

# --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Auth Functions) ---
# ... (Ø¯ÙˆØ§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
def sign_up_user(email, password):
    """ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±."""
    if not supabase: return
    try:
        supabase.auth.sign_up({"email": email, "password": password})
        st.success(t('signup_success'))
        st.session_state['auth_mode'] = 'login'
        st.session_state['temp_email'] = email
        st.rerun()
    except Exception as e:
        st.error(f"{t('signup_error')} {e}")

def sign_in_user(email, password):
    """ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŒ Ø«Ù… Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø®Ø·ÙˆØ© OTP."""
    if not supabase: return
    try:
        response = supabase.auth.sign_in_with_password({"email": email, "password": password})
        
        if response.user:
            supabase.auth.sign_out() 
            st.session_state['temp_email'] = email
            st.session_state['auth_mode'] = 'otp_verify'
            
            supabase.auth.sign_in_with_otp({"email": email}) 
            st.rerun() 
        else:
            st.error(t('login_invalid'))
    except Exception as e:
        error_message = str(e)
        if "Invalid login credentials" in error_message or "AuthApiError" in error_message:
            st.error(t('login_invalid'))
        else:
            st.error(f"{t('verification_error')} {e}")

def verify_otp_code(email, token):
    """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù…Ø² OTP ÙˆØ¥ÙƒÙ…Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„."""
    if not supabase: return
    try:
        response = supabase.auth.verify_otp({"email": email, "token": token, "type": "email"})
        
        if response.user:
            st.session_state['user'] = response.user
            st.session_state['page'] = 'Home'
            st.session_state['temp_email'] = None
            st.success(t('verification_success')) 
            st.rerun() 
        else:
            st.error(t('otp_invalid'))
            
    except Exception as e:
        error_message = str(e)
        if "Invalid" in error_message or "invalid" in error_message or "AuthApiError" in error_message:
            st.error(t('otp_invalid'))
        else:
            st.error(f"{t('otp_error')} {e}")

def reset_password(email):
    """
    Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² OTP Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¹Ù†Ø¯ Ù†Ø³ÙŠØ§Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.
    """
    if not supabase: return
    try:
        supabase.auth.sign_in_with_otp({"email": email})
        
        st.session_state['temp_email'] = email
        st.session_state['auth_mode'] = 'otp_verify'
        
        st.success(t('otp_sent_info'))
        st.rerun() 
        
    except Exception as e:
        st.error(f"{t('password_reset_error')} {e}")

def logout_user():
    """ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙ…Ø³Ø­ Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø³Ø©."""
    if not supabase: return
    try:
        supabase.auth.sign_out()
        st.session_state['user'] = None
        st.session_state['page'] = 'Home'
        st.session_state['auth_mode'] = 'login'
        st.session_state['temp_email'] = None 
        st.info(t('logged_out'))
        st.rerun() 
    except Exception as e:
        st.error(f"Error during logout: {e}")
# -----------------------------------------------

# --- Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ù…Ù„ÙØ§Øª (Product and File Management Functions) ---
GLASS_VOLUME_ML = 250

def upload_image_to_storage(image_file, prefix="products"):
    if not supabase: return None
    try:
        file_extension = image_file.name.split(".")[-1]
        file_name = f"{prefix}-{uuid.uuid4()}.{file_extension}"
        bucket_name = "product_images" 

        file_bytes = image_file.read()

        supabase.storage.from_(bucket_name).upload(
            file=file_bytes,
            path=file_name,
            file_options={"content-type": image_file.type}
        )

        public_url = supabase.storage.from_(bucket_name).get_public_url(file_name)
        return public_url
    except Exception as e:
        st.error(f"{t('image_upload_error')} {e}")
        return None

def add_new_product(name, calories, sugar, protein, fats, carbs, suitability, image_url):
    if not supabase: return
    try:
        supabase.table("products").insert({"name": name, "calories": calories, "sugar": sugar, "protein": protein, "fats": fats, "carbs": carbs, "suitability": suitability, "image_url": image_url}).execute()
        st.success(t('product_added_success'))
    except Exception as e:
        st.error(f"{t('product_added_failed')} {e}")

def update_product_in_db(product_id, data_to_update):
    if not supabase: return
    try:
        supabase.table("products").update(data_to_update).eq("id", product_id).execute()
        st.success(t('product_updated_success'))
    except Exception as e:
        st.error(f"{t('product_updated_failed')} {e}")

def delete_product_from_db(product_id):
    if not supabase: return
    try:
        supabase.table("products").delete().eq("id", product_id).execute()
        st.success(t('product_deleted_success'))
    except Exception as e:
        st.error(f"{t('product_deleted_failed')} {e}")

# --- Ø¯ÙˆØ§Ù„ Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© ØµÙˆØ± Ø§Ù„ØµÙØ­Ø§Øª ---

@st.cache_data(ttl=300) # ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª Ù„Ù…Ø¯Ø© 5 Ø¯Ù‚Ø§Ø¦Ù‚
def fetch_page_image_url(key):
    """Ø¬Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø²Ù† Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª."""
    if not supabase: return None
    try:
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙØªØ§Ø­ ÙÙŠ Ø¬Ø¯ÙˆÙ„ 'settings'
        response = supabase.table("settings").select("value").eq("key", key).single().execute()
        if response.data:
            return response.data['value']
        # Ø±Ø§Ø¨Ø· Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¥Ø¹Ø¯Ø§Ø¯
        return "https://placehold.co/600x200/cccccc/333333?text=NO+IMAGE+SET"
    except Exception:
        # Ø±Ø§Ø¨Ø· Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙÙŠ Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„
        return "https://placehold.co/600x200/cccccc/333333?text=DB+ERROR"

def update_page_image_url(key, url):
    """ØªØ­Ø¯ÙŠØ« Ø£Ùˆ Ø¥Ø¯Ø±Ø§Ø¬ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª."""
    if not supabase: return
    try:
        # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ„Ø§Ù‹
        response = supabase.table("settings").update({"value": url}).eq("key", key).execute()
        if not response.data or len(response.data) == 0:
            # Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« (Ø§Ù„Ù…ÙØªØ§Ø­ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯)ØŒ Ù‚Ù… Ø¨Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬
            supabase.table("settings").insert({"key": key, "value": url}).execute()
        
        # Ù…Ø³Ø­ Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ø¬Ø¹Ù„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ØªØ¸Ù‡Ø±
        st.cache_data.clear()
        st.success(t('image_updated_success'))
    except Exception as e:
        st.error(f"{t('image_updated_failed')} {e}")


# --- Ø¯ÙˆØ§Ù„ Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…ÙŠØ§Ù‡ ÙˆØ§Ù„Ø±ÙŠØ§Ø¶Ø© (Calculator and Exercise Functions) ---
# ... (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
def calculate_water_intake(weight_kg, age_years):
    if weight_kg <= 15 or age_years <= 5: 
        return 0 
        
    if 18 <= age_years <= 30:
        recommended_ml = weight_kg * 35
    elif 31 <= age_years <= 55:
        recommended_ml = weight_kg * 30
    else:
        recommended_ml = weight_kg * 25
    return recommended_ml / 1000

# --- Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø°ÙŠ ÙŠØ¬Ø¨ ÙˆØ¶Ø¹Ù‡ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ… ---
def get_exercise_recommendation(age, weight):
    # Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆØ²Ø§Ù† ÙˆØ§Ù„Ø£Ø¹Ù…Ø§Ø± ØºÙŠØ± Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØ© Ø£Ùˆ ØºÙŠØ± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„ØªØµÙ†ÙŠÙ
    if age < 5 or weight < 15:
        return t('rec_realistic_input')
        
    # --- Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ© 1: Ø§Ù„Ø£Ø·ÙØ§Ù„ ÙˆØ§Ù„Ù…Ø±Ø§Ù‡Ù‚ÙˆÙ† (Ø£Ù‚Ù„ Ù…Ù† 18 Ø³Ù†Ø©) ---
    if age < 18:
        # Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙˆØ²Ù† Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø³Ù…Ù†Ø©/Ø§Ù„Ù†Ø­Ø§ÙØ©ØŒ Ø¨Ù„ Ù†Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¹Ø§Ù…
        return t('rec_under_18_updated')
    
    # --- Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ© 2: Ø§Ù„Ø¨Ø§Ù„ØºÙˆÙ† (18 - 40 Ø³Ù†Ø©) ---
    elif age <= 40:
        if weight < 60:
            # Ù†Ø­ÙŠÙ
            return t('rec_18_40_underweight')
        elif 60 <= weight <= 80:
            # ÙˆØ²Ù† ØµØ­ÙŠ
            return t('rec_18_40_healthy')
        else: # weight > 80
            # ÙˆØ²Ù† Ø²Ø§Ø¦Ø¯/Ø³Ù…Ù†Ø©
            return t('rec_18_40_overweight')
            
    # --- Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ© 3: ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù† (ÙÙˆÙ‚ 40 Ø³Ù†Ø©) ---
    else: # age > 40
        if weight < 70: # ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø­Ø¯ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù†
            # Ù†Ø­ÙŠÙ/Ù†Ø­Ø§ÙØ© Ø·Ø¨ÙŠØ¹ÙŠØ©
            return t('rec_over_40_light')
        else:
            # ÙˆØ²Ù† Ø²Ø§Ø¦Ø¯/Ø³Ù…Ù†Ø©
            return t('rec_over_40_heavy')
# ----------------------------------------------------------------

def log_water_intake():
    st.session_state['water_consumed_ml'] = st.session_state.get('water_consumed_ml', 0) + GLASS_VOLUME_ML

def reset_water_intake():
    st.session_state['water_consumed_ml'] = 0

# --- ØµÙØ­Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (App Pages) ---

def show_auth_page():
    # ... (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
    st.title(t('login_register'))
    st.markdown(f"*{t('otp_note')}*") 

    cols = st.columns(3)
    
    if cols[0].button(t('login_button'), key='auth_login_btn'):
        st.session_state['auth_mode'] = 'login'
    if cols[1].button(t('signup_button'), key='auth_signup_btn'):
        st.session_state['auth_mode'] = 'signup'
    if cols[2].button(t('forgot_password_button'), key='auth_reset_btn'):
        st.session_state['auth_mode'] = 'reset'

    st.markdown("---")
    
    if st.session_state['auth_mode'] == 'otp_verify' and st.session_state['temp_email']:
        email_to_verify = st.session_state['temp_email']
        st.subheader(t('verify_otp_title'))
        st.info(t('otp_sent_info'))
        
        with st.form(key="otp_verify_form_key"):
            st.markdown(f"**Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù€:** `{email_to_verify}`")
            otp_code = st.text_input(t('enter_otp'), max_chars=6, key='otp_input')
            submit_button = st.form_submit_button(t('verify_otp_button'))
            
            if submit_button:
                if otp_code:
                    verify_otp_code(email_to_verify, otp_code)
                else:
                    st.warning(t('otp_invalid'))

    elif st.session_state['auth_mode'] == 'login':
        st.subheader(t('login_button'))
        default_email = st.session_state['temp_email'] if st.session_state['temp_email'] else ""
        with st.form(key="login_form_key"):
            email = st.text_input(t('enter_email'), key='login_email', value=default_email)
            password = st.text_input(t('password_label'), type='password', key='login_password')
            submit_button = st.form_submit_button(t('login_button'))
            
            if submit_button:
                if email and password:
                    sign_in_user(email, password)
                else:
                    st.warning(t('enter_email_password_warning'))

    elif st.session_state['auth_mode'] == 'signup':
        st.subheader(t('signup_button'))
        with st.form(key="signup_form_key"):
            email = st.text_input(t('enter_email'), key='signup_email')
            password = st.text_input(t('password_label'), type='password', key='signup_password')
            submit_button = st.form_submit_button(t('signup_button'))
            
            if submit_button:
                if email and password:
                    if len(password) < 6:
                        st.error(t('password_length_error'))
                    else:
                        sign_up_user(email, password)
                else:
                    st.warning(t('enter_email_password_warning'))

    elif st.session_state['auth_mode'] == 'reset':
        st.subheader(t('forgot_password_button'))
        with st.form(key="reset_form_key"):
            email = st.text_input(t('enter_email_for_reset'), key='reset_email')
            submit_button = st.form_submit_button(t('send_reset_link_button'))
            
            if submit_button:
                if email:
                    reset_password(email)
                else:
                    st.warning(t('enter_email_password_warning'))

def show_home_page():
    st.title(t('welcome'))
    
    # *** Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¬Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ***
    image_url = fetch_page_image_url('home_image_url')
    st.image(image_url, caption=t('app_title'), use_column_width=True) 
    
    st.write(t('app_purpose'))
    st.write(t('explore_features'))

def show_products_page():
    # ... (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
    st.title(t('products_page'))
    st.image("https://placehold.co/600x200/50C878/FFFFFF?text=Healthy+Foods") # Placeholder for catalog intro
    search_query = st.text_input(t('search_product'))
    try:
        query = supabase.table("products").select("*")
        if search_query:
            query = query.ilike("name", f"%{search_query}%")
        products = query.execute().data
        if products:
            for product in products:
                suitability_keys = ['suitable', 'moderately_suitable', 'not_suitable']
                suitability_key_lookup = {key: t(key) for key in suitability_keys}
                suitability_text = suitability_key_lookup.get(product.get('suitability', 'not_suitable'), product.get('suitability', 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'))
                
                st.subheader(f"{product['name']} - {t('suitability_label')}: {suitability_text}")
                
                try:
                    st.image(product['image_url'], width=200)
                except Exception:
                    st.warning(t('loading_image_error') + f" {product['image_url']}")

                st.write(f"**{t('calories')}:** {product['calories']}")
                carbs_value = product.get('carbs')
                st.write(f"**{t('carbs_g')}:** {carbs_value if carbs_value is not None else 'N/A'}")
                st.write(f"**{t('sugar_g')}:** {product['sugar']}g")
                st.write(f"**{t('protein_g')}:** {product['protein']}g")
                st.write(f"**{t('fats_g')}:** {product['fats']}g")
                st.write("---")
        else:
            st.info(t('no_products_found'))
    except Exception as e:
        st.error(f"{t('error_fetching_products')} {e}")

def show_admin_page():
    st.title(t('admin_dashboard'))
    admin_password = st.text_input(t('admin_password'), type="password")
    SECRET_CODE = "admin123" # ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„
    if admin_password == SECRET_CODE:
        # Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¯Ø§Ø±Ø© ØµÙˆØ± Ø§Ù„ØµÙØ­Ø§Øª
        show_page_image_management()
        st.markdown("---")
        # Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        show_add_product_form()
        st.markdown("---")
        # Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        show_edit_delete_form()
    else:
        st.warning(t('admin_access_denied'))

def show_page_image_management():
    st.subheader(t('manage_page_images'))

    page_options = {
        t('home_image'): 'home_image_url',
        t('exercise_image'): 'exercise_image_url',
        t('water_image'): 'water_image_url',
    }

    with st.form(key="page_image_form_key"):
        selected_page_name = st.selectbox(t('select_image_to_upload'), list(page_options.keys()))
        uploaded_image = st.file_uploader(t('upload_new_image'), type=["png", "jpg", "jpeg"])
        submit_button = st.form_submit_button(t('upload_page_image_button'))

        current_key = page_options[selected_page_name]
        current_url = fetch_page_image_url(current_key)
        
        st.markdown(f"**{t('current_consumption')}:**")
        try:
            st.image(current_url, width=200)
        except Exception:
             st.warning(t('loading_image_error') + f" {current_url}")


        if submit_button:
            if uploaded_image:
                with st.spinner(t('updating_image_spinner')):
                    # prefix Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„ØµÙØ­Ø© Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„ØµÙˆØ± ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ†
                    prefix = current_key.replace('_image_url', '') 
                    image_url = upload_image_to_storage(uploaded_image, prefix=prefix)
                    if image_url:
                        update_page_image_url(current_key, image_url)
                        st.rerun()
            else:
                st.warning(t('no_image_uploaded'))


def show_add_product_form():
    # ... (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
    st.subheader(t('add_product'))
    suitability_keys = ['suitable', 'moderately_suitable', 'not_suitable']
    suitability_options_translated = [t(key) for key in suitability_keys]
    
    with st.form(key="add_product_form_key"):
        product_name = st.text_input(t('product_name'))
        calories = st.number_input(t('calories'), min_value=0)
        sugar = st.number_input(t('sugar_g'), min_value=0.0)
        carbs = st.number_input(t('carbs_g'), min_value=0.0)
        protein = st.number_input(t('protein_g'), min_value=0.0)
        fats = st.number_input(t('fats_g'), min_value=0.0)
        suitability_translated = st.selectbox(t('suitability_question'), suitability_options_translated)
        uploaded_image = st.file_uploader(t('upload_image'), type=["png", "jpg", "jpeg"])
        submit_button = st.form_submit_button(t('add_product_button'))
        if submit_button:
            if uploaded_image and product_name:
                with st.spinner(t('adding_product_spinner')):
                    image_url = upload_image_to_storage(uploaded_image)
                    if image_url:
                        db_suitability_key = suitability_keys[suitability_options_translated.index(suitability_translated)]
                        add_new_product(product_name, calories, sugar, protein, fats, carbs, db_suitability_key, image_url)
            else:
                st.warning(t('fill_all_fields'))

def show_edit_delete_form():
    # ... (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
    st.subheader(t('edit_delete_product'))
    try:
        products = supabase.table("products").select("*").execute().data
        if products:
            product_names = {product['name']: product for product in products}
            selected_product_name = st.selectbox(t('select_product_to_edit'), list(product_names.keys()))

            if selected_product_name:
                selected_product = product_names[selected_product_name]
                
                suitability_options_keys = ['suitable', 'moderately_suitable', 'not_suitable']
                suitability_options_translated = [t(key) for key in suitability_options_keys]
                
                with st.form(key="edit_product_form_key"):
                    st.image(selected_product.get('image_url', 'https://placehold.co/200x200'), width=200) 
                    
                    new_name = st.text_input(t('product_name'), value=selected_product['name'])
                    new_calories = st.number_input(t('calories'), value=selected_product['calories'], min_value=0)

                    def safe_number(key, product):
                        value = product.get(key)
                        return float(value) if value is not None else 0.0

                    new_sugar = st.number_input(t('sugar_g'), value=safe_number('sugar', selected_product), min_value=0.0)
                    new_carbs = st.number_input(t('carbs_g'), value=safe_number('carbs', selected_product), min_value=0.0)
                    new_protein = st.number_input(t('protein_g'), value=safe_number('protein', selected_product), min_value=0.0)
                    new_fats = st.number_input(t('fats_g'), value=safe_number('fats', selected_product), min_value=0.0)
                    
                    db_suitability_key = selected_product['suitability'] if selected_product['suitability'] in suitability_options_keys else suitability_options_keys[0]
                    current_translated_value = t(db_suitability_key)
                    
                    current_index = suitability_options_translated.index(current_translated_value)

                    new_suitability_translated = st.selectbox(t('suitability_question'), suitability_options_translated, index=current_index)
                    new_image = st.file_uploader(t('upload_new_image'), type=["png", "jpg", "jpeg"])

                    col1, col2 = st.columns(2)
                    with col1:
                        update_button = st.form_submit_button(t('update_product'))
                    with col2:
                        delete_button = st.form_submit_button(t('delete_product'))

                    if update_button:
                        image_url_to_update = selected_product['image_url']
                        if new_image:
                            with st.spinner(t('updating_image_spinner')):
                                image_url_to_update = upload_image_to_storage(new_image)
                        
                        db_suitability_update = suitability_options_keys[suitability_options_translated.index(new_suitability_translated)]
                        
                        data_to_update = {
                            "name": new_name, 
                            "calories": new_calories, 
                            "sugar": new_sugar, 
                            "carbs": new_carbs, 
                            "protein": new_protein, 
                            "fats": new_fats, 
                            "suitability": db_suitability_update
                        }
                        if new_image: 
                            data_to_update["image_url"] = image_url_to_update
                            
                        update_product_in_db(selected_product['id'], data_to_update)
                        st.rerun()

                    if delete_button:
                        delete_product_from_db(selected_product['id'])
                        st.rerun() 
        else:
            st.info(t('no_products_available'))
    except Exception as e:
        st.error(f"{t('error_loading_products')} {e}")

def show_water_calculator_page():
    st.title(t('water_calc_title'))
    st.write(t('water_calc_desc'))
    
    # *** Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¬Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ***
    image_url = fetch_page_image_url('water_image_url')
    st.image(image_url, caption=t('water_calc_title'), use_column_width=True)

    with st.form(key="water_goal_form_key"):
        weight_kg = st.number_input(t('weight_kg'), min_value=15.0, value=70.0, key='water_weight') 
        age_years = st.number_input(t('age_years'), min_value=5, value=30, key='water_age') 
        calculate_button = st.form_submit_button(t('calculate'))
    
    if calculate_button:
        if weight_kg < 15 or age_years < 5:
            st.warning(t('realistic_input_warning'))
            st.session_state['water_goal_liters'] = 0.0 
        else:
            recommended_liters = calculate_water_intake(weight_kg, age_years)
            st.session_state['water_goal_liters'] = recommended_liters
            st.success(f"{t('recommended_intake')} **{recommended_liters:.2f} {t('liters')}**.")

    st.markdown("---")
    st.subheader(f"ğŸ’§ {t('daily_goal')}")
    
    water_goal_ml = st.session_state.get('water_goal_liters', 0.0) * 1000
    consumed_ml = st.session_state.get('water_consumed_ml', 0) 

    if water_goal_ml > 0:
        progress_ratio = min(consumed_ml / water_goal_ml, 1.0)
        progress_percent = int(progress_ratio * 100)
    else:
        progress_ratio = 0.0
        progress_percent = 0

    st.markdown(f"**{t('current_consumption')}:** $${consumed_ml} \\text{{ml}} / {water_goal_ml:.0f} \\text{{ml}}$$")
    st.progress(progress_ratio, text=f"{progress_percent}%")

    if progress_ratio >= 1.0:
        st.balloons()
        st.success(t('goal_reached'))

    col1, col2 = st.columns(2)
    
    with col1:
        st.button(t('log_glass'), on_click=log_water_intake, use_container_width=True, type='primary')
    
    with col2:
        st.button(t('reset_water'), on_click=reset_water_intake, use_container_width=True)

    st.markdown("---")
    with st.expander(t('water_tips_title')):
        st.write(f"- **{t('water_tip1')}**")
        st.write(f"- **{t('water_tip2')}**")
        st.write(f"- **{t('water_tip3')}**")
        st.write(f"- **{t('water_tip4')}**")


def show_exercise_page():
    st.title(t('exercise_title'))
    st.write(t('exercise_desc'))
    
    # *** Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¬Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ***
    image_url = fetch_page_image_url('exercise_image_url')
    st.image(image_url, caption=t('exercise_title'), use_column_width=True) 
    
    with st.form(key="exercise_form_key"):
        age = st.number_input(t('age_years'), min_value=5, value=30) 
        weight = st.number_input(t('weight_kg'), min_value=15.0, value=70.0) 
        get_rec_button = st.form_submit_button(t('get_rec'))
    if get_rec_button:
        if age < 5 or weight < 15:
            st.warning(t('realistic_input_warning'))
        else:
            st.info(get_exercise_recommendation(age, weight))
    with st.expander(t('exercise_tips_title')):
        st.write(f"- **{t('exercise_tip1')}**")
        st.write(f"- **{t('exercise_tip2')}**")
        st.write(f"- **{t('exercise_tip3')}**")
        st.write(f"- **{t('exercise_tip4')}**")

# --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù…Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ© ---
st.sidebar.title(t('navigation'))

# Ù‚Ø§Ø¦Ù…Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ØºØ©
lang_options = {'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©': 'ar', 'English': 'en'}
current_lang_display = 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' if st.session_state['language'] == 'ar' else 'English'
selected_lang_display = st.sidebar.radio("Language / Ø§Ù„Ù„ØºØ©", list(lang_options.keys()), index=list(lang_options.keys()).index(current_lang_display))

# Ø¥Ø°Ø§ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©ØŒ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ«Ù‡Ø§ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
if st.session_state['language'] != lang_options[selected_lang_display]:
    st.session_state['language'] = lang_options[selected_lang_display]
    st.rerun()

if st.session_state['user']:
    if st.sidebar.button(t('logout')):
        logout_user()
    
    page_options = {
        t('home_page'): show_home_page, 
        t('products_page'): show_products_page, 
        t('admin_page'): show_admin_page, 
        t('water_page'): show_water_calculator_page, 
        t('exercise_page'): show_exercise_page
    }
    
    current_page_func_name = st.session_state['page'].lower() + '_page'
    current_page_translated_name = next((k for k, v in page_options.items() if v.__name__ == 'show_' + current_page_func_name), t('home_page'))

    page_name_translated = st.sidebar.radio(t('navigation'), list(page_options.keys()), index=list(page_options.keys()).index(current_page_translated_name))
    
    for name, func in page_options.items():
        if name == page_name_translated:
            st.session_state['page'] = func.__name__.replace('show_', '').replace('_page', '').capitalize()
            func()
            break
else:
    show_auth_page()
